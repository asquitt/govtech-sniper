#!/bin/bash
# Git pre-commit hook for govtech-sniper monorepo
# Runs ruff (Python) and tsc (TypeScript) on staged files
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

STAGED=$(git diff --cached --name-only --diff-filter=ACM)

# ── Python checks ──────────────────────────────────────────────
BACKEND_PY=$(echo "$STAGED" | grep -E '^backend/.*\.py$' || true)
if [ -n "$BACKEND_PY" ]; then
    echo "Running ruff lint on staged Python files..."
    # Strip backend/ prefix so per-file-ignores resolve correctly
    PY_RELATIVE=$(echo "$BACKEND_PY" | sed 's|^backend/||')
    (cd backend && echo "$PY_RELATIVE" | xargs ruff check)
    echo "Running ruff format check..."
    (cd backend && echo "$PY_RELATIVE" | xargs ruff format --check)
fi

# ── TypeScript checks ─────────────────────────────────────────
TS_FILES=$(echo "$STAGED" | grep -E '\.(ts|tsx)$' || true)
if [ -n "$TS_FILES" ]; then
    echo "Running tsc on frontend..."
    cd frontend && npx tsc --noEmit && cd ..
fi

echo "Pre-commit checks passed."
